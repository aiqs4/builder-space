name: Deploy EKS

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        default: 'up'
        type: choice
        options:
        - up

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
    - uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    - uses: pulumi/actions@v6
      with:
        pulumi-version: latest
    - run: pip install -r requirements.txt

    - name: Deploy
      run: |
        pulumi login ${{ secrets.PULUMI_BACKEND_URL }}
        pulumi stack select eks --create
        pulumi up --yes