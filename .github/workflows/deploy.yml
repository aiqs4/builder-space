name: Deploy EKS Infrastructure (Pulumi)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - up
        - destroy
        - refresh

permissions:
  id-token: write
  contents: read

jobs:
  pulumi:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Setup Pulumi
      uses: pulumi/actions@v6
      with:
        pulumi-version: latest

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Validate AWS credentials and backend
      run: |
        echo "ðŸ” Validating AWS credentials..."
        aws sts get-caller-identity
        
        echo "ðŸ—„ï¸ Validating backend state storage..."
        if [ -n "${{ secrets.PULUMI_BACKEND_URL }}" ]; then
          # Extract bucket name from backend URL
          BUCKET_NAME=$(echo "${{ secrets.PULUMI_BACKEND_URL }}" | sed 's/s3:\/\///')
          aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null && echo "âœ… State bucket accessible" || echo "âš ï¸ State bucket access issue"
        fi
        
        echo "ðŸŽ¯ Checking EKS prerequisites..."
        aws eks list-clusters || echo "EKS access check completed"
        
        echo "âœ… Validation completed"

    - name: Configure Pulumi
      run: |
        echo "ðŸŽ¯ Configuring Pulumi backend..."
        pulumi login ${{ secrets.PULUMI_BACKEND_URL }}
        
        # Get KMS key ARN from bootstrap stack
        echo "ðŸ”‘ Getting KMS key ARN from bootstrap stack..."
        cd ..
        BOOTSTRAP_KMS_KEY_ARN=$(cd bootstrap && pulumi stack output kms_key_arn 2>/dev/null || echo "")
        cd -
        
        if [ -n "$BOOTSTRAP_KMS_KEY_ARN" ]; then
          echo "Using KMS key for secrets: $BOOTSTRAP_KMS_KEY_ARN"
          pulumi stack select dev --create --secrets-provider="awskms://$BOOTSTRAP_KMS_KEY_ARN"
        else
          echo "No KMS key found from bootstrap, using default secrets provider"
          pulumi stack select dev --create
        fi
        echo "âœ… Pulumi backend configured"

    - name: Pulumi Refresh
      run: |
        echo "ðŸ”„ Refreshing Pulumi state..."
        pulumi refresh --yes || echo "No existing state to refresh"
        echo "âœ… State refresh completed"
      if: ${{ contains(fromJson('["preview","up","refresh"]'), github.event.inputs.action) }}

    - name: Pulumi Preview
      run: |
        echo "ðŸ‘€ Previewing infrastructure changes..."
        pulumi preview --diff
        echo "âœ… Preview completed"
      if: ${{ contains(fromJson('["preview","up"]'), github.event.inputs.action) }}

    - name: Pulumi Up
      run: |
        echo "ðŸš€ Deploying EKS infrastructure..."
        
        # Deploy with retry logic for transient errors
        for attempt in 1 2 3; do
          echo "Attempt $attempt/3"
          if pulumi up --yes; then
            echo "âœ… Deployment successful on attempt $attempt"
            break
          else
            if [ $attempt -eq 3 ]; then
              echo "âŒ All deployment attempts failed"
              exit 1
            fi
            echo "âš ï¸ Attempt $attempt failed, retrying in 60 seconds..."
            sleep 60
          fi
        done
        
        echo "âœ… EKS infrastructure deployment completed"
      if: github.event.inputs.action == 'up'

    - name: Post-deployment Validation
      run: |
        echo "ðŸ” Validating EKS cluster deployment..."
        
        # Get cluster name from secrets or default
        CLUSTER_NAME="${{ secrets.CLUSTER_NAME }}"
        if [ -z "$CLUSTER_NAME" ]; then
          CLUSTER_NAME="builder-space"
        fi
        
        # Update kubeconfig
        echo "ðŸ“‹ Updating kubeconfig..."
        aws eks --region ${{ secrets.AWS_REGION }} update-kubeconfig --name "$CLUSTER_NAME"
        
        # Validate cluster connectivity
        echo "ðŸ”— Testing cluster connectivity..."
        if kubectl cluster-info 2>/dev/null; then
          echo "âœ… Cluster connectivity verified"
        else
          echo "âš ï¸ Cluster connectivity issue - will retry"
          sleep 30
          kubectl cluster-info
        fi
        
        # Check cluster nodes
        echo "ðŸ–¥ï¸ Checking cluster nodes..."
        kubectl get nodes -o wide || echo "âš ï¸ Node check failed - cluster may still be initializing"
        
        # Check system pods
        echo "ðŸƒ Checking system pods..."
        kubectl get pods -A --field-selector=status.phase!=Running 2>/dev/null || echo "All system pods running"
        
        # Basic cluster health summary
        echo "## ðŸ” EKS Cluster Validation" >> $GITHUB_STEP_SUMMARY
        echo "- Cluster: $CLUSTER_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- Region: ${{ secrets.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Cluster connectivity: âœ…" >> $GITHUB_STEP_SUMMARY
        
        NODE_COUNT=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")
        echo "- Active nodes: $NODE_COUNT" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Cluster validation completed"
      env:
        PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      if: github.event.inputs.action == 'up' && success()

    - name: Update kubeconfig and verify cluster
      run: |
        echo "ðŸ”§ Final cluster verification..."
        CLUSTER_NAME="${{ secrets.CLUSTER_NAME }}"
        if [ -z "$CLUSTER_NAME" ]; then
          CLUSTER_NAME="builder-space"
        fi
        
        aws eks --region ${{ secrets.AWS_REGION }} update-kubeconfig --name "$CLUSTER_NAME"
        kubectl get nodes
        kubectl get pods -A
        echo "âœ… Cluster verification completed successfully"
      if: github.event.inputs.action == 'up' && success()

    - name: Pulumi Destroy
      run: |
        echo "ðŸ—‘ï¸ Destroying EKS infrastructure..."
        pulumi destroy --yes
        echo "âš ï¸ EKS infrastructure destroyed" >> $GITHUB_STEP_SUMMARY
      if: github.event.inputs.action == 'destroy'

    - name: Cost Estimation Summary
      run: |
        echo "## ðŸ’° Estimated Monthly Costs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Based on current configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- EKS Cluster: $72.00/month" >> $GITHUB_STEP_SUMMARY
        echo "- Node Group (2x t4g.small): $28.80/month" >> $GITHUB_STEP_SUMMARY
        echo "- EBS Storage (40GB): $8.00/month" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Estimated: $108.80/month**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Cost Optimization Tips:**" >> $GITHUB_STEP_SUMMARY
        echo "- Use spot instances: Save ~70% on nodes" >> $GITHUB_STEP_SUMMARY
        echo "- Scale to 1 node for dev: Save ~$14/month" >> $GITHUB_STEP_SUMMARY
        echo "- Use scheduled shutdown: Save ~65% during off-hours" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”§ **Migration from Terraform:**" >> $GITHUB_STEP_SUMMARY
        echo "- Legacy Terraform code archived in terraform-legacy/" >> $GITHUB_STEP_SUMMARY
        echo "- All functionality preserved with improved Python modularity" >> $GITHUB_STEP_SUMMARY
        echo "- Cost optimization features maintained" >> $GITHUB_STEP_SUMMARY
        echo "- Enhanced robustness with idempotent deployments" >> $GITHUB_STEP_SUMMARY
      if: ${{ contains(fromJson('["preview","up"]'), github.event.inputs.action) }}